<!--Many thanks to http://rainingchain.com/tutorial/html5 for teaching me how to do all of this!-->

<canvas id="ctx" width="500" height="800" style="border:3px solid #000000;"></canvas>

<script>
var ctx = document.getElementById("ctx").getContext("2d");
ctx.font = '60px Courier New';

var HEIGHT = 800;
var WIDTH = 500;

var score = 0;
var player;

var enemyList = {};
var bulletList = {};

createPlayer = function(){

	player = {
		x:220,
		y:780,
		width:60,
		height:20,
		pressingKey:false,
		modNum:0,
		pressingLeft:false,
		pressingRight:false,
		hp:500,
	};
}

Enemy = function(x,y,radius,number){
	var enemy = {
		id:Math.random(),
		x:x,
		y:y,
		radius:radius,
		spdY:0,
		number:number,
	};
	
	enemyList[enemy.id] = enemy;
}

Bullet = function(x,y,spdX,spdY,radius,number){

	var bullet = {
		id:Math.random(),
		x:x,
		y:y,
		spdX:spdX,
		spdY:spdY,
		radius:radius,
		number:number,
	};
	
	bulletList[bullet.id] = bullet;
}

generateEnemy = function(x,y,radius,number){

	Enemy(x,y,radius,number);
}

generateBullet = function(actor){

	Bullet(actor.x, actor.y, 0, -15, 50, actor.modNum);
	//Bullet(100, actor.y, 0, -15, 50, actor.modNum);
}

// UPDATE LOOP
update = function(){

	ctx.clearRect(0,0,WIDTH,HEIGHT);
	updatePlayer();
	
	for(var key in bulletList)
	{
		updateBullet(bulletList[key]);
		
		var toRemove = false;
		
		if(bulletList[key].y < 0)
		{
			console.log("out of bounds " + bulletList[key].number);
			toRemove = true;
		}
		
		for(var key2 in enemyList){
			if(testCollisionCircle(enemyList[key2], bulletList[key]))
			{
				console.log("colliding! " + bulletList[key].number);
				var originalNumber = enemyList[key2].number;
				enemyList[key2].number = enemyList[key2].number % bulletList[key].number;
				
				// If player successully modded to 0, reward player and destroy enemy.
				if(enemyList[key2].number === 0)
				{
					score += originalNumber + 100;
					delete enemyList[key2];	
				}
				
				toRemove = true;
			}
		}
		
		if(toRemove){
			delete bulletList[key];
		}
	}
	
	for(var key in enemyList){
		updateEnemy(enemyList[key]);
		if(enemyList[key].y > HEIGHT - enemyList[key].radius)
		{
			player.hp -= enemyList[key].number;
			delete enemyList[key];
		}
	}
	
	ctx.save();
	ctx.font = '20px Courier New';
	ctx.fillText("Health: " + player.hp,10,30);
	ctx.fillText("Score: " + score,10,60);
	ctx.restore();
}

updatePlayer = function(){
	updatePlayerPosition();
	drawPlayer();
	
}

updateEnemy = function(enemy){
	updateEnemyPosition(enemy);
	drawEnemy(enemy);
}

updateBullet = function(bullet){

	bullet.x += bullet.spdX;
	bullet.y += bullet.spdY;
	drawBullet(bullet);
}

drawPlayer = function(){

	ctx.fillRect(player.x, player.y, player.width, player.height);

}

drawEnemy = function(enemy){

	var text = enemy.number;
	var width = ctx.measureText(text).width;
	ctx.fillText(text, enemy.x-(width/2), enemy.y+20);
	
	ctx.beginPath();
	ctx.arc(enemy.x, enemy.y, enemy.radius, 0, 2*Math.PI);
	ctx.closePath();
	ctx.stroke();
}

drawBullet = function(bullet){
	
	
	
	var text = bullet.number;
	var width = ctx.measureText(text).width;
	ctx.fillText(text, bullet.x-(width/2), bullet.y+20);
	
	ctx.beginPath();
	ctx.arc(bullet.x, bullet.y, bullet.radius, 0, 2*Math.PI);
	ctx.closePath();
	ctx.stroke();
}

document.onkeydown = function(event){
	player.pressingKey = true;
		
	switch(event.which || event.keyCode){
		case 39: //right arrow
		case 68: //'d'
			player.pressingRight = true;
			break;
		case 37: //left arrow
		case 65: //a
			player.pressingLeft = true;
			break;
	}
}

document.onkeyup = function(event){
	player.pressingKey = false;
		
	switch(event.which || event.keyCode){
		case 49 || 97:
			player.modNum = 1;
			generateBullet(player);
			break;
		case 50 || 98:
			player.modNum = 2;
			generateBullet(player);
			break;
		case 51 || 99:
			player.modNum = 3;
			generateBullet(player);
			break;
		case 52 || 100:
			player.modNum = 4;
			generateBullet(player);
			break;
		case 53 || 101:
			player.modNum = 5;
			generateBullet(player);
			break;
		case 54 || 102:
			player.modNum = 6;
			generateBullet(player);
			break;
		case 55 || 103:
			player.modNum = 7;
			generateBullet(player);
			break;
		case 56 || 104:
			player.modNum = 8;
			generateBullet(player);
			break;
		case 57 || 105:
			player.modNum = 9;
			generateBullet(player);
			break;
		case 39: //right arrow
		case 68: //'d'
			player.pressingRight = false;
			break;
		case 37: //left arrow
		case 65: //a
			player.pressingLeft = false;
			break;
		default:
			startNewGame();
	}	
	
	console.log('press!' + event.key);
	
	
}

testCollisionCircle = function(cir1, cir2){
	return cir1.x <= cir2.x+cir2.radius
		&& cir2.x <= cir1.x+cir1.radius
		&& cir1.y <= cir2.y+cir2.radius
		&& cir2.y <= cir1.y+cir1.radius
}

updatePlayerPosition = function(){

	if(player.pressingRight)
		player.x +=10;
	if(player.pressingLeft)
		player.x -=10;
		
	if(player.x < 0)
		player.x = 0;
	if(player.x > WIDTH - player.width)
		player.x = WIDTH - player.width;
	
}

updateEnemyPosition = function(enemy){

	if(enemy.number > 99)
	{
		enemy.spdY = 1;
	}
	else if(enemy.number > 9){
		enemy.spdY = 5;
	}
	else{
		enemy.spdY = 10;
	}
	
	enemy.y +=enemy.spdY;
}

startNewGame = function(){
	createPlayer();
	generateEnemy(225, 100, 50, 9);
	generateEnemy(325, 200, 50, 14);
	generateEnemy(425, 300, 50, 231);
	generateEnemy(125, 500, 50, 7);
	generateEnemy(95, 300, 50, 114);
}

startNewGame();
setInterval(update, 40);
</script>